# 기본 문법

## 목차

1. JPQL vs Querydsl
2. 기본 Q-Type 활용
3. 검색 조건 쿼리
4. 결과 조회
5. 정렬
6. 페이징
7. 집합
8. 조인 - 기본조인
9. 조인 - on 절
10. 조인 - 페치 조인
11. 서브 쿼리
12. Case 문
13. 상수, 문자 더하기

------



## 1. JPQL vs Querydsl

- JPQL은 `setParameter`로 파라미터 바인딩을 해주어야 하지만 Querydsl은 `.eq()`을 통해 바인딩 처리가 된다.
- JPQL은 String을 사용하기 때문에 컴파일 타임에 오류를 확인할 수 없다.
- Querydsl은 컴파일 타임에 오류를 잡아준다.

### JPQL

```java
@Test
public void startJPQL() {
    String query = "select m from Member m where m.username = :username";
    Member findMember = em.createQuery(query, Member.class)
            .setParameter("username", "member1")
            .getSingleResult();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

### Querydsl

```java
@Test
public void startQuerydsl() {
    JPAQueryFactory queryFactory = new JPAQueryFactory(em);
    QMember m = QMember.member;

    Member findMember = queryFactory.selectFrom(m)
            .where(m.username.eq("member1"))
            .fetchOne();

    assertThat(findMember.getUsername()).isEqualTo("member1");
}
```



## 2. 기본 Q-Type 활용

### Q클래스 인스턴스는 사용하는 방법

```java
QMember qMember = new QMember("m"); // 별칭 직접 지정
QMember qMember = QMember.member; // 기본 인스턴스 사용
```

- 기본 인스턴스를 사용하는 경우 아래와 같이 더 깔끔하게 표현할 수 있다.

```java
import static study.querydsl.entity.QMember.*;

@Test
public void startQuerydsl() {
	Member findMember = queryFactory.selectFrom(member)
					.where(member.username.eq("member1"))
					.fetchOne();
	
	assertThat(findMember.getUsername()).isEqualTo("member1");
}
```

- 참고: 같은 테이블을 조인하는 것이 아니라는 기본 인스턴스를 사용하자.



## 3. 검색 조건 쿼리

- Querydsl은 JPQL이 제공하는 모든 검색 조건을 제공한다.

```java
member.username.eq("member1") // username = 'member1'

member.username.ne("member1") //username != 'member1'
member.username.eq("member1").not() // username != 'member1'

member.username.isNotNull() //이름이 is not null

member.age.in(10, 20) // age in (10,20)
member.age.notIn(10, 20) // age not in (10, 20)

member.age.between(10,30) //between 10, 30

member.age.goe(30) // age >= 30
member.age.gt(30) // age > 30
member.age.loe(30) // age <= 30
member.age.lt(30) // age < 30

member.username.like("member%") //like 검색
member.username.contains("member") // like ‘%member%’ 검색
member.username.startsWith("member") //like ‘member%’ 검색
```

- 검색 조건은 `.and()`, `.or()`를 메서드 체인으로 연결할 수 있다.

```java
@Test
public void search() {
    Member findMember = queryFactory.selectFrom(QMember.member)
            .where(QMember.member.username.eq("member1")
                    .and(QMember.member.age.eq(10)))
            .fetchOne();

    assertThat(findMember.getUsername()).isEqualTo("member1");
    assertThat(findMember.getAge()).isEqualTo(10);
}
```

- `.and()` 대신 `,` 를 사용해도 된다.

```java
@Test
public void searchAndParam() {
    Member findMember = queryFactory.selectFrom(QMember.member)
            .where(
                    QMember.member.username.eq("member1"),
                    QMember.member.age.eq(10)
            )
            .fetchOne();

    assertThat(findMember.getUsername()).isEqualTo("member1");
    assertThat(findMember.getAge()).isEqualTo(10);
}
```



## 4. 결과 조회

- fetch(): 리스트 조회, 데이터가 없으면 빈 리스트 반환
- fetchOne(): 한 건 조회
  - 결과가 없으면 null
  - 결과가 둘 이상이면 NoUniqueResultException
- fetchFirst(): limit(1).fetchOne()
- fetchResults(): 페이징 정보 포함 (total count 쿼리 추가 실행)
- fetchCount(): count 쿼리로 변경해서 count 수 조회

```java
@Test
public void resultFetch() {
    List<Member> fetch = queryFactory.selectFrom(member).fetch();

    Member fetchOne = queryFactory.selectFrom(member).fetchOne();

    Member fetchFirst = queryFactory.selectFrom(QMember.member).fetchFirst();

    QueryResults<Member> fetchResults = queryFactory.selectFrom(member).fetchResults();
    long offset = fetchResults.getOffset();
    long total = fetchResults.getTotal();
    List<Member> results = fetchResults.getResults();

    long fetchCount = queryFactory.selectFrom(member).fetchCount();
}
```

- 참고: fetchResults()와 fetchCount()는 deprecated 되었음
  - 복잡한 쿼리에서 제대로 동작하지 않는 이슈



## 5. 정렬

```java
/**
 * 회원 정렬 순서
 * 1. 회원 나이 내림차순 (desc)
 * 2. 회원 이름 오름차순 (asc)
 * 단 2에서 회원 이름이 없으면 마지막에 출력 (nulls last)
 */
@Test
public void sort() {
    em.persist(new Member(null, 100));
    em.persist(new Member("member5", 100));
    em.persist(new Member("member6", 100));

    List<Member> result = queryFactory.selectFrom(member)
            .where(member.age.eq(100))
            .orderBy(member.age.desc(), member.username.asc().nullsLast())
            .fetch();

    Member member5 = result.get(0);
    Member member6 = result.get(1);
    Member memberNull = result.get(2);

    assertThat(member5.getUsername()).isEqualTo("member5");
    assertThat(member6.getUsername()).isEqualTo("member6");
    assertThat(memberNull.getUsername()).isNull();
}
```

- desc(), asc(): 내림차순, 오름차순
- nullLast(), nullFirst(): null 데이터 순서



## 6. 페이징

## 7. 집합

## 8. 조인 - 기본 조인

## 9. 조인 - on 절

## 10. 조인 - 페치 조인

## 11. 서브 쿼리

## 12. Case 문

## 13. 상수, 문자 더하기